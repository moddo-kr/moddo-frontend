# Merge Commitsì— Prefixë¥¼ ì¶”ê°€í•˜ëŠ” Github Actions
name: Add Prefix to Merge Commits

on:
  pull_request:
    types:
      - closed # PRì´ ë‹«í˜”ì„ ë•Œ íŠ¸ë¦¬ê±°

jobs:
  add-prefix:
    if: github.event.pull_request.merged == true # ë³‘í•©ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the target branch
        uses: actions/checkout@v4 # https://github.com/actions/checkout
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Github Actionsì—ì„œ ì‚¬ìš©í•˜ëŠ” ê¸°ë³¸ í† í°
          ref: ${{ github.event.pull_request.base.ref }} # PRì˜ íƒ€ê²Ÿ ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒ
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ë³´ì¡´í•˜ê¸° ìœ„í•´ 0ìœ¼ë¡œ ì„¤ì • (ê¸°ë³¸ê°’: 1)

      # "empty ident name" ì—ëŸ¬ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©ì ì •ë³´ ì„¤ì • (GITHUB_TOKEN ìœ ì €)
      # https://github.com/actions/checkout?tab=readme-ov-file#push-a-commit-using-the-built-in-token
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add Prefix
        run: |
          PREFIX="merge: "
          # ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸° (ì „ì²´ ë©”ì‹œì§€: ì œëª© + ë³¸ë¬¸)
          # - https://git-scm.com/docs/pretty-formats
          LAST_FULL_MESSAGE=$(git log -1 --pretty=%B)

          # ì»¤ë°‹ ë©”ì‹œì§€ì˜ ì²« ë²ˆì§¸ ì¤„(ì œëª©)ë§Œ ì¶”ì¶œ
          # head -n 1: ì…ë ¥ì—ì„œ ì²˜ìŒ 1ì¤„ë§Œ ì¶œë ¥
          TITLE=$(echo "$LAST_FULL_MESSAGE" | head -n 1)

          # ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì´ë¯¸ PREFIXë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° ë³€ê²½í•˜ì§€ ì•ŠìŒ
          if [[ $TITLE == "$PREFIX"* ]]; then
            echo "ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€ì— ì´ë¯¸ '$PREFIX' ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 0
          fi

          # PREFIXë¥¼ ì œëª© ì•ì— ì¶”ê°€
          # sed "1s/^/$PREFIX /": ì²« ë²ˆì§¸ ì¤„ì˜ ì‹œì‘(^)ì— PREFIXë¥¼ ì¶”ê°€
          NEW_MESSAGE=$(echo "$LAST_FULL_MESSAGE" | sed "1s/^/$PREFIX/")

          # ì»¤ë°‹ ë©”ì‹œì§€ ìˆ˜ì •
          # --amend: ë§ˆì§€ë§‰ ì»¤ë°‹ì„ ìˆ˜ì •
          # -F: ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ íŒŒì¼ì—ì„œ ì½ìŒ
          # -F -: í‘œì¤€ ì…ë ¥ì—ì„œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì½ìŒ
          echo "$NEW_MESSAGE" | git commit --amend -F -

          # ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
          # --force-with-lease: ë¦¬ëª¨íŠ¸ ë¸Œëœì¹˜ì— ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ í‘¸ì‹œ
          # https://git-scm.com/docs/git-push#Documentation/git-push.txt---no-force-with-lease
          # https://docs.github.com/articles/changing-a-commit-message
          git push --force-with-lease

          # ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
          echo "âœ… ì»¤ë°‹ ë©”ì‹œì§€ì— '$PREFIX' ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤."
