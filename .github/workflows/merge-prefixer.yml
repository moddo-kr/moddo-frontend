# Merge Commits에 Prefix를 추가하는 Github Actions
name: Add Prefix to Merge Commits

on:
  pull_request:
    types:
      - closed # PR이 닫혔을 때 트리거

jobs:
  add-prefix:
    if: github.event.pull_request.merged == true # 병합된 경우에만 실행
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the target branch
        uses: actions/checkout@v4 # https://github.com/actions/checkout
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Github Actions에서 사용하는 기본 토큰
          ref: ${{ github.event.pull_request.base.ref }} # PR의 타겟 브랜치를 체크아웃
          fetch-depth: 0 # 전체 히스토리를 보존하기 위해 0으로 설정 (기본값: 1)

      # "empty ident name" 에러를 방지하기 위해 사용자 정보 설정 (GITHUB_TOKEN 유저)
      # https://github.com/actions/checkout?tab=readme-ov-file#push-a-commit-using-the-built-in-token
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add Prefix
        run: |
          PREFIX="merge: "
          # 마지막 커밋 메시지 가져오기 (전체 메시지: 제목 + 본문)
          # - https://git-scm.com/docs/pretty-formats
          LAST_FULL_MESSAGE=$(git log -1 --pretty=%B)

          # 커밋 메시지의 첫 번째 줄(제목)만 추출
          # head -n 1: 입력에서 처음 1줄만 출력
          TITLE=$(echo "$LAST_FULL_MESSAGE" | head -n 1)

          # 커밋 메시지가 이미 PREFIX로 시작하는 경우 변경하지 않음
          if [[ $TITLE == "$PREFIX"* ]]; then
            echo "💬 커밋 메시지에 이미 '$PREFIX' 가 포함되어 있으므로 변경하지 않습니다."
            exit 0
          fi

          # PREFIX를 제목 앞에 추가
          # sed "1s/^/$PREFIX /": 첫 번째 줄의 시작(^)에 PREFIX를 추가
          NEW_MESSAGE=$(echo "$LAST_FULL_MESSAGE" | sed "1s/^/$PREFIX/")

          # 커밋 메시지 수정
          # --amend: 마지막 커밋을 수정
          # -F: 커밋 메시지를 파일에서 읽음
          # -F -: 표준 입력에서 커밋 메시지를 읽음
          echo "$NEW_MESSAGE" | git commit --amend -F -

          # 변경사항 푸시
          # --force-with-lease: 리모트 브랜치에 변경사항이 없는 경우에만 푸시
          # https://git-scm.com/docs/git-push#Documentation/git-push.txt---no-force-with-lease
          # https://docs.github.com/articles/changing-a-commit-message
          git push --force-with-lease

          # 완료 메시지 출력
          echo "✅ 커밋 메시지에 '$PREFIX' 를 추가했습니다."
