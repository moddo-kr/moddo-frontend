name: Automate PR Reviews

on:
  pull_request:
    types: [opened, ready_for_review, synchronize] # PR ìƒì„± ì‹œ ë˜ëŠ” Draft ìƒíƒœì—ì„œ 'ë¦¬ë·° ê°€ëŠ¥' ìƒíƒœë¡œ ì „í™˜ë  ë•Œ íŠ¸ë¦¬ê±°ë˜ëŠ” ì•¡ì…˜

jobs:
  # PR ì‘ì„±ìë¥¼ Assigneeë¡œ ì§€ì •í•˜ê³  Reviewerë¥¼ ì§€ì •í•˜ëŠ” ì‘ì—…
  assign:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Assigneeì™€ Reviewer í• ë‹¹ì„ ìœ„í•œ ê¶Œí•œ
    steps:
      - uses: hkusu/review-assign-action@v1 # https://github.com/hkusu/review-assign-action
        with:
          # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/accessing-contextual-information-about-workflow-runs#github-context
          assignees: ${{ github.actor }} # PR ì‘ì„±ìë¥¼ assigneeë¡œ ì§€ì •
          # Repository Variablesì— ì •ì˜í•œ ê°’
          # - Settings > Secrets and Variables > Actions > Variables > Repository variables
          reviewers: ${{ vars.REVIEWERS }} # ë¦¬ë·°í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì˜ ëª©ë¡

  # ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ JIRA ì´ìŠˆ í‚¤ë¥¼ ì¶”ì¶œí•˜ì—¬ PR ë³¸ë¬¸ì— ë§í¬ë¡œ ì¶”ê°€í•˜ëŠ” ì‘ì—…
  add-jira-link:
    runs-on: ubuntu-latest
    steps:
      - name: Extract JIRA issue key from branch name
        id: extract-jira-key
        run: |
          JIRA_KEY=$(echo ${{ github.head_ref }} | grep -oE 'MOD-[0-9]+' || echo "")
          echo "jira_key=$JIRA_KEY" >> "$GITHUB_OUTPUT"

      # PR ë³¸ë¬¸ì„ JSON í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•˜ê¸° ìœ„í•œ jq ì„¤ì¹˜
      - name: Install jq
        if: steps.extract-jira-key.outputs.jira_key != '' # JIRA ì´ìŠˆ í‚¤ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        run: sudo apt-get update && sudo apt-get install -y jq

      # https://docs.github.com/en/rest/pulls/pulls?apiVersion=2022-11-28#update-a-pull-request
      - name: Add JIRA issue link to PR body
        if: steps.extract-jira-key.outputs.jira_key != '' # JIRA ì´ìŠˆ í‚¤ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        run: |
          PR_BODY=$(cat <<EOF
          ${{ github.event.pull_request.body }}
          EOF)
          JIRA_KEY=${{ steps.extract-jira-key.outputs.jira_key }}
          JIRA_LINK=$(printf "## ğŸ“ ê´€ë ¨ ì´ìŠˆ\n\n[%s](%s/browse/%s)" "$JIRA_KEY" "${{ vars.JIRA_BASE_URL }}" "$JIRA_KEY")
          UPDATED_BODY=$(printf "%s\n\n%s" "$JIRA_LINK" "$PR_BODY")
          curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} \
            -d "$(jq -n --arg body "$UPDATED_BODY" '{body: $body}')"
